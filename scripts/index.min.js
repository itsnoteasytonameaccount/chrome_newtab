"strict mode";{const{storage:{sync:e},bookmarks:t,contextMenus:i,search:{query:n,Disposition:{NEW_TAB:r}}}=chrome;const o="assets/bg/planet.png";const l=new Image;l.addEventListener("load",(function(){document.body.querySelector("main").style.backgroundImage=`url(${this.src})`}));l.src=o;const a=promiseDecoration(t.create,t);const s=promiseDecoration(t.getRecent,t);const c=promiseDecoration(e.set,e);const d=promiseDecoration(e.get,e);const u=promiseDecoration(t.getChildren,t);const h=promiseDecoration(t.remove,t);let m={_count:0,_current:0,_timerId:0,maskRendered:false,loadedBookmarks:[],id:-1,get page(){return this._count?Math.ceil(this.loadedBookmarks.length/this._count):0},get count(){return this._count},async updateCount(){let e=document.querySelector("div.carousel");let t=Math.floor((e.offsetWidth-1)/140)*2;let i=(e.offsetWidth-1)%140/2;e.style.padding="0 "+i+"px";if(t!==this._count){this._count=t;if(this.loadedBookmarks.length===0){let{children:e,id:t}=await loadBookmarks();this.loadedBookmarks=e;this.id=t}this.reset()}},get current(){return this._current},set current(e){if(e<0||e>=this.page){return}if(e!==this._current){let t=this._current;let i=document.querySelector("div.bookmarks ul");this._current=e;i.style.marginLeft=-100*e+"%";this.initialPage(e);clearTimeout(this._timerId);this._timerId=setTimeout((()=>{if(t>-1){this.selectPage(t).innerHTML=""}}),500)}},blockTemplate:({title:e,url:t,id:i})=>{i=i?`_id="${i}"`:"";let n=t?`<img class="md-icon" src="chrome://favicon/size/32@1x/${t}">`:"<i class='iconfont icon-add'></i>";return`<li class="bookmark-block" ${i}>\n        <div class="content">\n            <p>${n}\n            </p>\n            <p>${e}</p>\n        </div>\n        <a  ${t?`href="${t}"`:""} title="${e}" target="_blank"></a>\n        <i class="iconfont icon-delete delete" ${i} ></i>\n    </li>`},initialPage(e){let i="",n=e*this._count,r=n+this._count>=this.loadedBookmarks.length?this.loadedBookmarks.length:n+this._count,o=this.selectPage(e);for(;n<r;n++){i+=this.blockTemplate(this.loadedBookmarks[n])}o.innerHTML=i;const l=o.querySelector("li:not([_id])");if(l){l.addEventListener("click",(()=>{document.querySelector(".mask").setAttribute("show","true");if(!this.maskRendered){this.maskRendered=true;t.getTree(maskRenderer.bind(null,[document.querySelector(".menu-function.exist")]))}}))}let a=document.querySelector(`div.carousel div.switcher a.active`);a&&(a.className="");document.querySelector(`div.carousel div.switcher a:nth-child(${e+1})`).className="active"},reset(){const e=document.querySelector("div.bookmarks"),t=e.nextElementSibling,i=this._current;let n="",r="",o=m.page;for(let e=0;e<o;e++){r+="<ul></ul>";n+=`<a _page='${e}'></a>`}e.innerHTML=r;t.innerHTML=n;this._current=-1;this.current=i},removeItem(e){let t=this.page;let i=document.createElement("div");let n=document.querySelector(".bookmark-block i[_id='"+e+"'");let r=this.loadedBookmarks;let o;this.cached[e]=null;n.parentNode.addEventListener("transitionend",(function(e){e.target.remove()}));n.parentNode.className+=" remove";for(o=this._current*this._count;o<r.length;o++){if(r[o].id===e){break}}r.splice(o,1);if(this.page<t){this.selectPage(t-1).remove();document.querySelector(`div.carousel div.switcher a:nth-child(${t})`).remove();if(this._current===t-1){this.current--}}if(this._current<t-1){i.innerHTML=this.blockTemplate(r[this._current*this._count+this._count-1]);this.selectPage(this._current).appendChild(i.childNodes[0])}},addItem(e){this.loadedBookmarks.splice(-1,1,e,{title:"添加",id:"",url:""});this.reset()},selectPage:e=>document.querySelector(`div.bookmarks ul:nth-child(${e+1})`),cached:{},has(e){if(this.cached[e]){return true}let t=this.loadedBookmarks;let i;for(i=0;i<t.length;i++){this.cached[t[i].id]=t[i];if(t[i].id===e){return true}}}};function throttle(e,t=500){let i=0;return function(...n){let r=Date.now();if(r-i>t){i=r;e.apply(this,n)}}}function contextmenuEvent(e){let t=this.className.split(" ");let i=()=>{this.className=this.className.replace("edit","");window.removeEventListener("click",i)};if(t.indexOf("edit")<0){t.push("edit");this.className=t.join(" ");window.addEventListener("click",i)}e.preventDefault()}async function initialListener(){const e=document.querySelector("div.bookmarks"),t=e.nextElementSibling;t.addEventListener("click",(function(e){e.stopPropagation();if(e.target===e.currentTarget){return}let t=parseInt(e.target.getAttribute("_page"));m.current=t}));e.addEventListener("click",(function(e){let t=e.target;let i;e.stopPropagation();if(t.nodeName!=="I"){t=t.parentNode}if(t.nodeName==="I"){i=t.getAttribute("_id");if(i){h(i)}}}));e.addEventListener("contextmenu",contextmenuEvent);e.addEventListener("mousewheel",throttle((function(e){if(e.deltaX<-3){m.current--}else if(e.deltaX>3){m.current++}})))}window.addEventListener("resize",throttle((function(){m.updateCount()})));function promiseDecoration(e,t){return async function i(...n){return await new Promise((i=>{e.call(t,...n,i)}))}}async function loadRecent(){let e=await a({parentId:"1",index:0,title:"扩展创建的书签目录"});let t={};t.id=e.id;let i=await s(m.count);i.forEach((e=>{a({parentId:t.id,title:e.title,url:e.url})}));c({bookmarks:t});return{id:e.id,children:i}}async function loadBookmarks(){let e;let t={};e=await d("bookmarks");if(!e.bookmarks){t=await loadRecent()}else{t.children=await u(e.bookmarks.id);if(!t.children){t=await loadRecent()}else{t.id=e.bookmarks.id}}t.children.push({title:"添加",url:"",id:""});return t}m.updateCount();initialListener();const f=({id:e,title:t,url:i})=>{let n=i?`<img class="md-icon" src="chrome://favicon/size/16@1x/${i}"></img>`:"";return`<input class="bookmark_check" type="checkbox" id="bookmark${e}" title="${t}" value="${i}">\n  <label for="bookmark${e}"><a class="iconfont" title="${t}">${n}${t}</a></label>`};function maskRenderer(e,t,i=0){let n,r,o;let l=[],a=[];for(let i=0;i<t.length;i++){o=t[i].children;n=document.createElement("ul");n.style.minHeight=25*o.length+"px";for(let e=0;e<o.length;e++){r=document.createElement("li");r.className=o[e].url?"item":"folder";r.innerHTML=f(o[e]);n.appendChild(r);if(o[e].children&&o[e].children.length){l.push(o[e]);a.push(r)}}e[i]&&e[i].appendChild(n)}if(l.length)return maskRenderer(a,l,i+1)}function message(e){let t=document.querySelector(".message");t.querySelector("div").textContent=e;t.style.display="block";setTimeout((()=>t.style.display="none"),3e3)}function initialMask(){let e=document.querySelector("div.mask");let t=e.querySelector("div.foreground");t.addEventListener("animationend",(function(e){if(this.getAttribute("show")==="false"){this.parentNode.setAttribute("show","false");this.setAttribute("show","true")}}));function i(e,i=t.querySelectorAll("input[type='checkbox']:checked")){t.setAttribute("show","false");for(let e=0;e<i.length;e++){i[e].checked=false}}t.querySelector("button.sure").addEventListener("click",(function(){let e=t.querySelectorAll(".item input[type='checkbox']:checked");let n=t.querySelector("input[type='radio']:checked").value;let r;if(n==="create"){r=t.querySelectorAll("input[type='text']");a({parentId:m.id,title:r[0].value,url:r[1].value}).then((e=>{if(!e){message("新增失败，可能是链接格式不对");return}}))}else{for(let t=0;t<e.length;t++){a({parentId:m.id,title:e[t].title,url:e[t].value})}}i(null,e)}));t.querySelector("button.cancel").addEventListener("click",i)}initialMask();function initialSearchBar(){const e=document.querySelector(".search-bar input");e.addEventListener("keyup",(function(e){if(e.keyCode===13){n({disposition:r,text:e.target.value})}}))}initialSearchBar();i.onClicked.addListener((function(e){if(e.menuItemId==="edit"){contextmenuEvent.call(document.querySelector("div.bookmarks"),{preventDefault(){}})}}));function updateAll(){let e=document.querySelector(".menu-function.exist");e.innerHTML="";m.maskRendered=false}t.onMoved.addListener(updateAll);t.onMoved.addListener((function(e,{oldParentId:i,parentId:n}){if(i===n){return}if(i===m.id){if(m.has(e)){m.removeItem(e)}return}if(n===m.id){if(!m.has(e)){t.get(e,(([e])=>{m.addItem(e)}))}else{message("已存在该书签")}}}));t.onCreated.addListener(updateAll);t.onCreated.addListener((function(e,t){if(t.parentId===m.id){m.addItem(t)}}));t.onRemoved.addListener(updateAll);t.onRemoved.addListener((function(e){if(m.has(e)){m.removeItem(e)}}))}